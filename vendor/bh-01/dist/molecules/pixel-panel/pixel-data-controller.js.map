{"version":3,"file":"pixel-data-controller.js","sources":["../../../src/molecules/pixel-panel/pixel-data-controller.ts"],"sourcesContent":["import type { ReactiveController, ReactiveControllerHost } from 'lit';\nimport { sparklineToGrid, barToGrid } from '../../primitives/pixel-renderers.js';\nimport { textToGrid } from '../../primitives/pixel-font.js';\n\nexport type PixelDataType = 'sparkline' | 'bar' | 'text' | 'raw';\n\nexport interface PixelDataControllerOptions {\n  cols: number;\n  rows: number;\n  type: PixelDataType;\n  color?: number;\n  bufferSize?: number;\n}\n\n/**\n * Manage pixel data buffering and grid generation.\n *\n * Push numeric values in; get a ready-to-render Uint8Array out.\n * Delegates to existing sparklineToGrid / barToGrid / textToGrid utilities.\n */\nexport class PixelDataController implements ReactiveController {\n  private _host: ReactiveControllerHost;\n  private _cols: number;\n  private _rows: number;\n  private _type: PixelDataType;\n  private _color: number;\n  private _bufferSize: number;\n  private _buffer: number[] = [];\n  private _text = '';\n  private _grid: Uint8Array;\n\n  constructor(host: ReactiveControllerHost, opts: PixelDataControllerOptions) {\n    this._host = host;\n    this._cols = opts.cols;\n    this._rows = opts.rows;\n    this._type = opts.type;\n    this._color = opts.color ?? 1;\n    this._bufferSize = opts.bufferSize ?? opts.cols;\n    this._grid = new Uint8Array(opts.cols * opts.rows);\n    host.addController(this);\n  }\n\n  hostConnected() {}\n  hostDisconnected() {}\n\n  get grid(): Uint8Array {\n    return this._grid;\n  }\n\n  get latest(): number | undefined {\n    return this._buffer.length > 0\n      ? this._buffer[this._buffer.length - 1]\n      : undefined;\n  }\n\n  get values(): readonly number[] {\n    return this._buffer.slice();\n  }\n\n  push(value: number): void {\n    this._buffer.push(value);\n    if (this._buffer.length > this._bufferSize) {\n      this._buffer = this._buffer.slice(this._buffer.length - this._bufferSize);\n    }\n    this._regenerate();\n  }\n\n  set(values: number[]): void {\n    this._buffer = values.slice(-this._bufferSize);\n    this._regenerate();\n  }\n\n  setText(text: string): void {\n    this._text = text;\n    this._regenerate();\n  }\n\n  setGrid(grid: Uint8Array): void {\n    this._applyGrid(grid);\n  }\n\n  resize(cols: number, rows: number): void {\n    this._cols = cols;\n    this._rows = rows;\n    this._grid = new Uint8Array(cols * rows);\n    this._regenerate();\n  }\n\n  configure(opts: Partial<PixelDataControllerOptions>): void {\n    let needsRegen = false;\n\n    if (opts.cols !== undefined && opts.cols !== this._cols) {\n      this._cols = opts.cols;\n      needsRegen = true;\n    }\n    if (opts.rows !== undefined && opts.rows !== this._rows) {\n      this._rows = opts.rows;\n      needsRegen = true;\n    }\n    if (opts.type !== undefined && opts.type !== this._type) {\n      this._type = opts.type;\n      needsRegen = true;\n    }\n    if (opts.color !== undefined && opts.color !== this._color) {\n      this._color = opts.color;\n      needsRegen = true;\n    }\n    if (opts.bufferSize !== undefined && opts.bufferSize !== this._bufferSize) {\n      this._bufferSize = opts.bufferSize;\n      if (this._buffer.length > this._bufferSize) {\n        this._buffer = this._buffer.slice(this._buffer.length - this._bufferSize);\n      }\n      needsRegen = true;\n    }\n\n    if (needsRegen) {\n      this._grid = new Uint8Array(this._cols * this._rows);\n      this._regenerate();\n    }\n  }\n\n  private _regenerate(): void {\n    const { _cols: cols, _rows: rows, _color: color, _type: type } = this;\n    if (cols === 0 || rows === 0) return;\n\n    let next: Uint8Array;\n    switch (type) {\n      case 'sparkline':\n        next = sparklineToGrid(this._buffer, cols, rows, color);\n        break;\n      case 'bar':\n        next = barToGrid(this._buffer.length > 0 ? this._buffer[this._buffer.length - 1] : 0, cols, rows, color);\n        break;\n      case 'text':\n        next = textToGrid(this._text, cols, rows, color);\n        break;\n      case 'raw':\n        return; // raw mode only uses setGrid\n    }\n\n    this._applyGrid(next!);\n  }\n\n  private _applyGrid(next: Uint8Array): void {\n    const prev = this._grid;\n    const len = Math.min(prev.length, next.length);\n    let changed = prev.length !== next.length;\n\n    if (!changed) {\n      for (let i = 0; i < len; i++) {\n        if (prev[i] !== next[i]) {\n          changed = true;\n          break;\n        }\n      }\n    }\n\n    if (changed) {\n      this._grid = next;\n      this._host.requestUpdate();\n    }\n  }\n}\n"],"names":["PixelDataController","host","opts","value","values","text","grid","cols","rows","needsRegen","color","type","next","sparklineToGrid","barToGrid","textToGrid","prev","len","changed","i"],"mappings":"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"}