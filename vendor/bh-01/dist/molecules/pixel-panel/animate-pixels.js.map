{"version":3,"file":"animate-pixels.js","sources":["../../../src/molecules/pixel-panel/animate-pixels.ts"],"sourcesContent":["import { AsyncDirective } from 'lit/async-directive.js';\nimport { directive, type PartInfo } from 'lit/directive.js';\nimport { noChange } from 'lit';\n\nexport type PixelTransition = 'step' | 'sweep';\n\nexport interface AnimatePixelsOptions {\n  transition?: PixelTransition;\n  fps?: number;\n  cols?: number;\n}\n\n/**\n * Directive that manages visual transitions between pixel grid states.\n *\n * Used in property bindings: `.data=${animatePixels(grid, opts)}`\n *\n * - **step**: Pass-through with fps throttle. The pixel-display CSS transition\n *   smooths individual pixel changes already.\n * - **sweep**: Left-to-right column reveal over ~0.3s. Produces intermediate\n *   frames via rAF until the sweep completes.\n */\nclass AnimatePixelsDirective extends AsyncDirective {\n  private _current?: Uint8Array;\n  private _target?: Uint8Array;\n  private _fps = 12;\n  private _cols = 0;\n\n  // Sweep state\n  private _sweepCursor = 0;\n  private _sweepSpeed = 1;\n  private _prev?: Uint8Array;\n  private _rafId = 0;\n\n  // Step throttle state\n  private _pending = false;\n  private _stepRafId = 0;\n\n  constructor(partInfo: PartInfo) {\n    super(partInfo);\n  }\n\n  render(grid: Uint8Array, opts?: AnimatePixelsOptions): Uint8Array | typeof noChange {\n    const transition = opts?.transition ?? 'step';\n    const fps = opts?.fps ?? 12;\n    const cols = opts?.cols ?? 0;\n\n    this._fps = fps;\n    this._cols = cols;\n\n    if (transition === 'sweep' && cols > 0) {\n      return this._handleSweep(grid);\n    }\n    return this._handleStep(grid);\n  }\n\n  private _handleStep(grid: Uint8Array): Uint8Array | typeof noChange {\n    // First render — always pass through\n    if (!this._current) {\n      this._current = grid;\n      return grid;\n    }\n\n    // Same reference — no change\n    if (grid === this._current) {\n      return noChange;\n    }\n\n    // Throttle: if we already have a pending frame, just update the target\n    this._target = grid;\n\n    if (this._pending) {\n      return noChange;\n    }\n\n    this._pending = true;\n    this._stepRafId = requestAnimationFrame(() => {\n      this._stepRafId = 0;\n      this._pending = false;\n      const latest = this._target!;\n      this._current = latest;\n      this._target = undefined;\n      this.setValue(latest);\n    });\n\n    return noChange;\n  }\n\n  private _handleSweep(grid: Uint8Array): Uint8Array | typeof noChange {\n    // First render — pass through\n    if (!this._current) {\n      this._current = grid;\n      return grid;\n    }\n\n    // Same reference — no change\n    if (grid === this._current) {\n      return noChange;\n    }\n\n    // New target: start sweep\n    this._cancelSweep();\n    this._prev = this._current;\n    this._target = grid;\n    this._sweepCursor = 0;\n    this._sweepSpeed = Math.ceil(this._cols / Math.ceil(0.3 * this._fps));\n    this._tickSweep();\n\n    return noChange;\n  }\n\n  private _tickSweep = (): void => {\n    if (!this._target || !this._prev) return;\n\n    this._sweepCursor += this._sweepSpeed;\n    const cols = this._cols;\n    const rows = this._target.length / cols;\n\n    if (this._sweepCursor >= cols) {\n      // Sweep complete\n      this._current = this._target;\n      this.setValue(this._target);\n      this._prev = undefined;\n      this._target = undefined;\n      this._rafId = 0;\n      return;\n    }\n\n    // Build intermediate frame\n    const intermediate = new Uint8Array(this._target.length);\n    for (let row = 0; row < rows; row++) {\n      for (let col = 0; col < cols; col++) {\n        const idx = row * cols + col;\n        intermediate[idx] = col < this._sweepCursor\n          ? this._target[idx]\n          : this._prev[idx];\n      }\n    }\n\n    this.setValue(intermediate);\n    this._rafId = requestAnimationFrame(this._tickSweep);\n  };\n\n  private _cancelSweep(): void {\n    if (this._rafId) {\n      cancelAnimationFrame(this._rafId);\n      this._rafId = 0;\n    }\n  }\n\n  protected override disconnected(): void {\n    this._cancelSweep();\n    if (this._stepRafId) {\n      cancelAnimationFrame(this._stepRafId);\n      this._stepRafId = 0;\n    }\n  }\n\n  protected override reconnected(): void {\n    // Resume mid-sweep if applicable\n    if (this._target && this._prev && this._sweepCursor < this._cols) {\n      this._rafId = requestAnimationFrame(this._tickSweep);\n    }\n  }\n}\n\nexport const animatePixels = directive(AnimatePixelsDirective);\nexport type { AnimatePixelsDirective };\n"],"names":["AnimatePixelsDirective","AsyncDirective","partInfo","cols","rows","intermediate","row","col","idx","grid","opts","transition","fps","noChange","latest","animatePixels","directive"],"mappings":";;;AAsBA,MAAMA,UAA+BC,EAAe;AAAA,EAgBlD,YAAYC,GAAoB;AAC9B,UAAMA,CAAQ,GAdhB,KAAQ,OAAO,IACf,KAAQ,QAAQ,GAGhB,KAAQ,eAAe,GACvB,KAAQ,cAAc,GAEtB,KAAQ,SAAS,GAGjB,KAAQ,WAAW,IACnB,KAAQ,aAAa,GA2ErB,KAAQ,aAAa,MAAY;AAC/B,UAAI,CAAC,KAAK,WAAW,CAAC,KAAK,MAAO;AAElC,WAAK,gBAAgB,KAAK;AAC1B,YAAMC,IAAO,KAAK,OACZC,IAAO,KAAK,QAAQ,SAASD;AAEnC,UAAI,KAAK,gBAAgBA,GAAM;AAE7B,aAAK,WAAW,KAAK,SACrB,KAAK,SAAS,KAAK,OAAO,GAC1B,KAAK,QAAQ,QACb,KAAK,UAAU,QACf,KAAK,SAAS;AACd;AAAA,MACF;AAGA,YAAME,IAAe,IAAI,WAAW,KAAK,QAAQ,MAAM;AACvD,eAASC,IAAM,GAAGA,IAAMF,GAAME;AAC5B,iBAASC,IAAM,GAAGA,IAAMJ,GAAMI,KAAO;AACnC,gBAAMC,IAAMF,IAAMH,IAAOI;AACzB,UAAAF,EAAaG,CAAG,IAAID,IAAM,KAAK,eAC3B,KAAK,QAAQC,CAAG,IAChB,KAAK,MAAMA,CAAG;AAAA,QACpB;AAGF,WAAK,SAASH,CAAY,GAC1B,KAAK,SAAS,sBAAsB,KAAK,UAAU;AAAA,IACrD;AAAA,EArGA;AAAA,EAEA,OAAOI,GAAkBC,GAA2D;AAClF,UAAMC,KAAaD,KAAA,gBAAAA,EAAM,eAAc,QACjCE,KAAMF,KAAA,gBAAAA,EAAM,QAAO,IACnBP,KAAOO,KAAA,gBAAAA,EAAM,SAAQ;AAK3B,WAHA,KAAK,OAAOE,GACZ,KAAK,QAAQT,GAETQ,MAAe,WAAWR,IAAO,IAC5B,KAAK,aAAaM,CAAI,IAExB,KAAK,YAAYA,CAAI;AAAA,EAC9B;AAAA,EAEQ,YAAYA,GAAgD;AAElE,WAAK,KAAK,WAMNA,MAAS,KAAK,WACTI,KAIT,KAAK,UAAUJ,GAEX,KAAK,WACAI,KAGT,KAAK,WAAW,IAChB,KAAK,aAAa,sBAAsB,MAAM;AAC5C,WAAK,aAAa,GAClB,KAAK,WAAW;AAChB,YAAMC,IAAS,KAAK;AACpB,WAAK,WAAWA,GAChB,KAAK,UAAU,QACf,KAAK,SAASA,CAAM;AAAA,IACtB,CAAC,GAEMD,OA1BL,KAAK,WAAWJ,GACTA;AAAA,EA0BX;AAAA,EAEQ,aAAaA,GAAgD;AAEnE,WAAK,KAAK,WAMNA,MAAS,KAAK,WACTI,KAIT,KAAK,aAAA,GACL,KAAK,QAAQ,KAAK,UAClB,KAAK,UAAUJ,GACf,KAAK,eAAe,GACpB,KAAK,cAAc,KAAK,KAAK,KAAK,QAAQ,KAAK,KAAK,MAAM,KAAK,IAAI,CAAC,GACpE,KAAK,WAAA,GAEEI,MAjBL,KAAK,WAAWJ,GACTA;AAAA,EAiBX;AAAA,EAkCQ,eAAqB;AAC3B,IAAI,KAAK,WACP,qBAAqB,KAAK,MAAM,GAChC,KAAK,SAAS;AAAA,EAElB;AAAA,EAEmB,eAAqB;AACtC,SAAK,aAAA,GACD,KAAK,eACP,qBAAqB,KAAK,UAAU,GACpC,KAAK,aAAa;AAAA,EAEtB;AAAA,EAEmB,cAAoB;AAErC,IAAI,KAAK,WAAW,KAAK,SAAS,KAAK,eAAe,KAAK,UACzD,KAAK,SAAS,sBAAsB,KAAK,UAAU;AAAA,EAEvD;AACF;AAEO,MAAMM,IAAgBC,EAAUhB,CAAsB;"}